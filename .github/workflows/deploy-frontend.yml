name: Deploy Frontend

on:
  push:
    branches: [main]
    paths:
      - 'frontend/**'
      - '.github/workflows/deploy-frontend.yml'
  workflow_dispatch:

env:
  RESOURCE_GROUP: case-management-simple

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Azure Login
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Get Backend API URL
        id: backend-url
        run: |
          # Find the container app
          containerAppName=$(az containerapp list \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query "[?contains(name, 'ca-api')].name" -o tsv | head -n 1)
          
          apiUrl=$(az containerapp show \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --name $containerAppName \
            --query properties.configuration.ingress.fqdn -o tsv)
          
          echo "apiUrl=https://$apiUrl/api" >> $GITHUB_OUTPUT
          echo "Backend API URL: https://$apiUrl/api"

      - name: Install dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Build frontend
        working-directory: ./frontend
        env:
          VITE_API_URL: ${{ steps.backend-url.outputs.apiUrl }}
        run: npm run build

      - name: Get Static Web App deployment token
        id: swa-token
        run: |
          # Find the static web app
          swaName=$(az staticwebapp list \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query "[0].name" -o tsv)
          
          if [ -z "$swaName" ]; then
            echo "⚠️ Static Web App not found. Creating one..."
            swaName="stapp-cm-simple-$(date +%s)"
            
            az staticwebapp create \
              --resource-group ${{ env.RESOURCE_GROUP }} \
              --name $swaName \
              --location westeurope \
              --sku Free
          fi
          
          deploymentToken=$(az staticwebapp secrets list \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --name $swaName \
            --query properties.apiKey -o tsv)
          
          echo "swaName=$swaName" >> $GITHUB_OUTPUT
          echo "::add-mask::$deploymentToken"
          echo "deploymentToken=$deploymentToken" >> $GITHUB_OUTPUT

      - name: Deploy to Azure Static Web Apps
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ steps.swa-token.outputs.deploymentToken }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: "upload"
          app_location: "frontend"
          output_location: "dist"
          skip_app_build: true

      - name: Set API URL in Static Web App
        run: |
          az staticwebapp appsettings set \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --name ${{ steps.swa-token.outputs.swaName }} \
            --setting-names VITE_API_URL=${{ steps.backend-url.outputs.apiUrl }}

      - name: Get Static Web App URL
        run: |
          swaUrl=$(az staticwebapp show \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --name ${{ steps.swa-token.outputs.swaName }} \
            --query defaultHostname -o tsv)
          
          echo "✅ Frontend deployed successfully!"
          echo "Frontend URL: https://$swaUrl"
